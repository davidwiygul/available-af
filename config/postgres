# postgres
#!/bin/bash

source ./provision.config


ssh -T -i $AWS_SSH_KEY ubuntu@$1 << HERE
    sudo apt-get install -y postgresql
    sudo -u postgres psql << THERE
        create user $DB_USER with encrypted password '$DB_PWD';
        create database $DATABASE owner $DB_USER;
        \q
THERE

    sudo -u postgres PGPASSWORD=$DB_PWD psql -h localhost -d $DATABASE -U $DB_USER -c 'create table schedulers(ip varchar(15), birth timestamp, latest timestamp);'

    sudo sed -i '/# IPv4 local connections:/a host\t$DATABASE\t$DB_USER\t\tsamenet\t\t\tmd5' /etc/postgresql/10/main/pg_hba.conf

    sudo sed -i "s/#listen_addresses.*/listen_addresses = '*'/" /etc/postgresql/10/main/postgresql.conf

    sudo systemctl restart postgresql

    exit

HERE

DB_IP=$(ssh -i $AWS_SSH_KEY ubuntu@$1 "hostname -I" | tr -d '[:space:]')

sed -i "s|^DB_IP.*|DB_IP='$DB_IP'|" provision.config
